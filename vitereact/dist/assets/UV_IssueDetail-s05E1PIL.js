import{a as O,u as H,b as N,j as e}from"./state-vendor-__gb9IU9.js";import{f as Q,r as h,L as v}from"./react-vendor-QYi6USC3.js";import{u as U,a as g}from"./index-CWN4_r_N.js";import{h as W,a6 as k,$ as K,P as V,F as G,au as J,f as I,z as X,G as S,H as Y,av as Z,k as ee,X as se}from"./ui-vendor-CuJPReAW.js";const p="https://urls-washer-articles-luke.trycloudflare.com",te=async(a,l)=>{const n=await g.get(`${p}/api/issues/${a}`,{headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"}});return{issue:n.data.issue,messages:n.data.messages||[]}},ae=async(a,l,n)=>(await g.post(`${p}/api/issues/${a}/messages`,l,{headers:{Authorization:`Bearer ${n}`,"Content-Type":"application/json"}})).data,re=async(a,l)=>(await g.post(`${p}/api/issues/${a}/accept-resolution`,{},{headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"}})).data.issue,le=async(a,l)=>{await g.post(`${p}/api/issues/${a}/escalate`,{},{headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"}})},ne=a=>({open:"bg-orange-100 text-orange-800 border-orange-200",under_review:"bg-blue-100 text-blue-800 border-blue-200",awaiting_response:"bg-yellow-100 text-yellow-800 border-yellow-200",resolved:"bg-green-100 text-green-800 border-green-200",closed:"bg-gray-100 text-gray-800 border-gray-200"})[a]||"bg-gray-100 text-gray-800 border-gray-200",ie=a=>({late_delivery:"Late Delivery",wrong_item:"Wrong Item Delivered",damaged_item:"Damaged Item",missing_item:"Missing Item",quality_issue:"Quality Issue",billing_issue:"Billing Issue",delivery_not_attempted:"Delivery Not Attempted",other:"Other Issue"})[a]||a,T=a=>({full_refund:"Full Refund",partial_refund:"Partial Refund",replacement:"Replacement Item",credit:"Store Credit",no_action:"No Action Needed"})[a]||a,w=a=>{const l=new Date(a);return new Intl.DateTimeFormat("en-US",{month:"short",day:"numeric",year:"numeric",hour:"numeric",minute:"2-digit",hour12:!0}).format(l)},oe=a=>{const l=new Date(a),o=new Date().getTime()-l.getTime(),d=Math.floor(o/6e4),c=Math.floor(o/36e5),x=Math.floor(o/864e5);return d<1?"Just now":d<60?`${d}m ago`:c<24?`${c}h ago`:x<7?`${x}d ago`:w(a)},ue=()=>{const{issue_id:a}=Q(),l=O(),n=U(t=>t.authentication_state.auth_token),[o,d]=h.useState(""),[c,x]=h.useState([]),[$,b]=h.useState(!1),[_,M]=h.useState(null),{data:m,isLoading:F,error:E}=H({queryKey:["issue",a],queryFn:()=>te(a,n),enabled:!!a&&!!n,staleTime:3e4,refetchOnWindowFocus:!0,retry:1}),u=N({mutationFn:t=>ae(a,t,n),onSuccess:()=>{l.invalidateQueries({queryKey:["issue",a]}),d(""),x([])},onError:t=>{var r,i;alert(((i=(r=t.response)==null?void 0:r.data)==null?void 0:i.message)||"Failed to send message. Please try again.")}}),f=N({mutationFn:()=>re(a,n),onSuccess:()=>{l.invalidateQueries({queryKey:["issue",a]})},onError:t=>{var r,i;alert(((i=(r=t.response)==null?void 0:r.data)==null?void 0:i.message)||"Failed to accept resolution. Please try again.")}}),y=N({mutationFn:()=>le(a,n),onSuccess:()=>{l.invalidateQueries({queryKey:["issue",a]})},onError:t=>{var r,i;alert(((i=(r=t.response)==null?void 0:r.data)==null?void 0:i.message)||"Failed to escalate issue. Please try again.")}}),D=t=>{t.preventDefault(),o.trim()&&u.mutate({message_text:o.trim(),attachments:c})},P=()=>{window.confirm("Are you sure you want to accept this resolution? This action cannot be undone.")&&f.mutate()},B=()=>{window.confirm("This will escalate your issue to BuildEasy admin support. Do you want to continue?")&&y.mutate()},R=t=>{M(t),b(!0)},s=(m==null?void 0:m.issue)||null,C=(m==null?void 0:m.messages)||[],z=!!(s!=null&&s.resolution_offered),L=(s==null?void 0:s.status)==="open"&&!(s!=null&&s.escalated_to_admin),j=(s==null?void 0:s.status)==="resolved"||(s==null?void 0:s.status)==="closed";return F?e.jsx(e.Fragment,{children:e.jsx("div",{className:"min-h-screen bg-gray-50 py-8",children:e.jsx("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"animate-pulse",children:[e.jsx("div",{className:"h-8 bg-gray-200 rounded w-1/3 mb-6"}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-6 mb-6",children:[e.jsx("div",{className:"h-6 bg-gray-200 rounded w-1/2 mb-4"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-full mb-2"}),e.jsx("div",{className:"h-4 bg-gray-200 rounded w-2/3"})]}),e.jsx("div",{className:"bg-white rounded-xl shadow-lg p-6",children:e.jsx("div",{className:"h-32 bg-gray-200 rounded"})})]})})})}):E?e.jsx(e.Fragment,{children:e.jsx("div",{className:"min-h-screen bg-gray-50 py-12",children:e.jsx("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"bg-white rounded-xl shadow-lg p-8 text-center",children:[e.jsx(W,{className:"mx-auto h-12 w-12 text-red-500 mb-4"}),e.jsx("h2",{className:"text-2xl font-bold text-gray-900 mb-2",children:"Issue Not Found"}),e.jsx("p",{className:"text-gray-600 mb-6",children:"We couldn't find this issue or you don't have permission to view it."}),e.jsxs(v,{to:"/orders",className:"inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors",children:[e.jsx(k,{className:"mr-2 h-5 w-5"}),"Back to Orders"]})]})})})}):s?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"min-h-screen bg-gray-50 py-8",children:e.jsxs("div",{className:"max-w-4xl mx-auto px-4 sm:px-6 lg:px-8",children:[e.jsx("div",{className:"mb-6",children:e.jsxs(v,{to:"/orders",className:"inline-flex items-center text-gray-600 hover:text-gray-900 font-medium transition-colors",children:[e.jsx(k,{className:"mr-2 h-5 w-5"}),"Back to Orders"]})}),e.jsx("div",{className:"bg-white rounded-xl shadow-lg border border-gray-100 p-6 mb-6",children:e.jsx("div",{className:"flex flex-col md:flex-row md:items-start md:justify-between gap-4",children:e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-3 mb-3",children:[e.jsxs("h1",{className:"text-2xl font-bold text-gray-900",children:["Issue #",s.issue_id.slice(-8).toUpperCase()]}),e.jsx("span",{className:`px-3 py-1 rounded-full text-xs font-semibold border ${ne(s.status)}`,children:s.status.replace("_"," ").toUpperCase()}),s.escalated_to_admin&&e.jsx("span",{className:"px-3 py-1 rounded-full text-xs font-semibold bg-purple-100 text-purple-800 border border-purple-200",children:"ESCALATED TO ADMIN"})]}),e.jsxs("div",{className:"flex flex-wrap items-center gap-x-6 gap-y-2 text-sm text-gray-600",children:[e.jsxs("div",{className:"flex items-center",children:[e.jsx(K,{className:"mr-2 h-4 w-4"}),"Opened ",w(s.opened_date)]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(V,{className:"mr-2 h-4 w-4"}),e.jsxs(v,{to:`/orders/${s.order_id}`,className:"text-blue-600 hover:text-blue-700 font-medium",children:["Order #",s.order_id.slice(-8).toUpperCase()]})]}),e.jsxs("div",{className:"flex items-center",children:[e.jsx(G,{className:"mr-2 h-4 w-4"}),ie(s.issue_type)]})]})]})})}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg border border-gray-100 p-6 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-4",children:"Issue Details"}),e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 mb-2",children:"Description"}),e.jsx("p",{className:"text-gray-900 leading-relaxed",children:s.description})]}),s.affected_items&&s.affected_items.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 mb-2",children:"Affected Items"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:s.affected_items.map((t,r)=>e.jsx("span",{className:"px-3 py-1 bg-gray-100 text-gray-700 text-sm rounded-md border border-gray-200",children:t},r))})]}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 mb-2",children:"Desired Resolution"}),e.jsx("span",{className:"inline-flex items-center px-3 py-1 bg-blue-50 text-blue-700 text-sm font-medium rounded-md border border-blue-200",children:T(s.desired_resolution)})]}),s.evidence_photos&&s.evidence_photos.length>0&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-sm font-medium text-gray-500 mb-3",children:"Evidence Photos"}),e.jsx("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-3",children:s.evidence_photos.map((t,r)=>e.jsxs("button",{onClick:()=>R(t),className:"relative aspect-square rounded-lg overflow-hidden border-2 border-gray-200 hover:border-blue-500 transition-all group",children:[e.jsx("img",{src:t,alt:`Evidence ${r+1}`,className:"w-full h-full object-cover group-hover:scale-105 transition-transform"}),e.jsx("div",{className:"absolute inset-0 bg-black bg-opacity-0 group-hover:bg-opacity-10 transition-opacity flex items-center justify-center",children:e.jsx(J,{className:"h-6 w-6 text-white opacity-0 group-hover:opacity-100 transition-opacity"})})]},r))})]})]})]}),z&&s.resolution_offered&&!j&&e.jsx("div",{className:"bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl shadow-lg border-2 border-green-200 p-6 mb-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"h-12 w-12 rounded-full bg-green-100 flex items-center justify-center",children:e.jsx(I,{className:"h-6 w-6 text-green-600"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-2",children:"Resolution Offered"}),e.jsxs("p",{className:"text-sm text-gray-600 mb-4",children:[s.assigned_admin_id?"BuildEasy Admin":"Supplier"," has offered a resolution for your issue:"]}),e.jsxs("div",{className:"bg-white rounded-lg p-4 mb-4 border border-green-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsx("span",{className:"text-sm font-medium text-gray-500",children:"Resolution Type"}),e.jsx("span",{className:"text-sm font-semibold text-gray-900",children:T(s.resolution_offered)})]}),s.resolution_amount&&e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium text-gray-500",children:"Amount"}),e.jsxs("span",{className:"text-lg font-bold text-green-600",children:["$",Number(s.resolution_amount||0).toFixed(2)]})]})]}),e.jsxs("div",{className:"flex flex-col sm:flex-row gap-3",children:[e.jsx("button",{onClick:P,disabled:f.isPending,className:"flex-1 px-6 py-3 bg-green-600 text-white font-medium rounded-lg hover:bg-green-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:f.isPending?e.jsxs("span",{className:"flex items-center justify-center",children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Accepting..."]}):"Accept Resolution"}),e.jsx("button",{type:"button",className:"flex-1 px-6 py-3 bg-white text-gray-700 font-medium rounded-lg border-2 border-gray-300 hover:bg-gray-50 transition-colors",children:"Decline & Continue Discussion"})]})]})]})}),e.jsxs("div",{className:"bg-white rounded-xl shadow-lg border border-gray-100 p-6 mb-6",children:[e.jsx("h2",{className:"text-lg font-semibold text-gray-900 mb-6",children:"Communication Thread"}),e.jsx("div",{className:"space-y-4 mb-6",children:C.length===0?e.jsxs("div",{className:"text-center py-8 text-gray-500",children:[e.jsx(X,{className:"mx-auto h-12 w-12 text-gray-300 mb-3"}),e.jsx("p",{children:"No messages yet. Start the conversation below."})]}):C.map(t=>{const r=t.sender_type==="customer",i=t.sender_type==="system";return e.jsx("div",{className:`flex ${r?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-xl ${r?"ml-12":"mr-12"}`,children:[e.jsxs("div",{className:`flex items-center gap-2 mb-1 ${r?"justify-end":"justify-start"}`,children:[e.jsxs("span",{className:"text-xs font-medium text-gray-500",children:[r&&"You",t.sender_type==="supplier"&&"Supplier",t.sender_type==="admin"&&"BuildEasy Admin",i&&"System"]}),e.jsx("span",{className:"text-xs text-gray-400",children:"â€¢"}),e.jsx("span",{className:"text-xs text-gray-400",children:oe(t.timestamp)})]}),e.jsxs("div",{className:`rounded-lg px-4 py-3 ${r?"bg-blue-600 text-white":i?"bg-gray-100 text-gray-700 border border-gray-200":"bg-white text-gray-900 border border-gray-200 shadow-sm"}`,children:[e.jsx("p",{className:"text-sm leading-relaxed whitespace-pre-wrap",children:t.message_text}),t.attachments&&t.attachments.length>0&&e.jsx("div",{className:"mt-3 pt-3 border-t border-gray-200/30 space-y-1",children:t.attachments.map((q,A)=>e.jsxs("a",{href:q,target:"_blank",rel:"noopener noreferrer",className:`flex items-center text-xs ${r?"text-blue-100 hover:text-white":"text-blue-600 hover:text-blue-700"}`,children:[e.jsx(S,{className:"mr-1 h-3 w-3"}),"Attachment ",A+1]},A))})]})]})},t.message_id)})}),!j&&e.jsxs("form",{onSubmit:D,className:"border-t border-gray-200 pt-6",children:[e.jsx("label",{htmlFor:"message_text",className:"block text-sm font-medium text-gray-700 mb-2",children:"Add a Message"}),e.jsx("textarea",{id:"message_text",value:o,onChange:t=>d(t.target.value),placeholder:"Type your message here...",rows:4,className:"w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-blue-500 focus:ring-4 focus:ring-blue-100 transition-all resize-none",disabled:u.isPending}),e.jsxs("div",{className:"mt-4 flex flex-col sm:flex-row items-start sm:items-center justify-between gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsxs("button",{type:"button",className:"inline-flex items-center px-3 py-2 text-sm text-gray-600 hover:text-gray-900 border border-gray-300 rounded-lg hover:bg-gray-50 transition-colors",children:[e.jsx(S,{className:"mr-2 h-4 w-4"}),"Attach Files"]}),c.length>0&&e.jsxs("span",{className:"text-xs text-gray-500",children:[c.length," file(s) attached"]})]}),e.jsx("button",{type:"submit",disabled:!o.trim()||u.isPending,className:"inline-flex items-center px-6 py-3 bg-blue-600 text-white font-medium rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:u.isPending?e.jsxs("span",{className:"flex items-center",children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx(Y,{className:"mr-2 h-4 w-4"}),"Send Message"]})})]})]}),j&&e.jsx("div",{className:"border-t border-gray-200 pt-6",children:e.jsxs("div",{className:"bg-green-50 border border-green-200 rounded-lg p-4 text-center",children:[e.jsx(I,{className:"mx-auto h-8 w-8 text-green-600 mb-2"}),e.jsx("p",{className:"text-sm font-medium text-green-800",children:"This issue has been resolved"}),s.resolved_date&&e.jsxs("p",{className:"text-xs text-green-600 mt-1",children:["Resolved on ",w(s.resolved_date)]})]})})]}),L&&e.jsx("div",{className:"bg-white rounded-xl shadow-lg border border-gray-100 p-6",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"h-10 w-10 rounded-full bg-amber-100 flex items-center justify-center",children:e.jsx(Z,{className:"h-5 w-5 text-amber-600"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"text-sm font-semibold text-gray-900 mb-1",children:"Need Additional Help?"}),e.jsx("p",{className:"text-sm text-gray-600 mb-4",children:"If the supplier's response is not satisfactory, you can escalate this issue to BuildEasy admin support for review."}),e.jsx("button",{onClick:B,disabled:y.isPending,className:"inline-flex items-center px-4 py-2 bg-amber-600 text-white text-sm font-medium rounded-lg hover:bg-amber-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed",children:y.isPending?e.jsxs("span",{className:"flex items-center",children:[e.jsxs("svg",{className:"animate-spin -ml-1 mr-2 h-4 w-4 text-white",fill:"none",viewBox:"0 0 24 24",children:[e.jsx("circle",{className:"opacity-25",cx:"12",cy:"12",r:"10",stroke:"currentColor",strokeWidth:"4"}),e.jsx("path",{className:"opacity-75",fill:"currentColor",d:"M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"})]}),"Escalating..."]}):e.jsxs(e.Fragment,{children:[e.jsx(ee,{className:"mr-2 h-4 w-4"}),"Escalate to Admin Support"]})})]})]})})]})}),$&&_&&e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-75 z-50 flex items-center justify-center p-4",onClick:()=>b(!1),children:e.jsxs("div",{className:"relative max-w-4xl max-h-[90vh]",children:[e.jsx("button",{onClick:()=>b(!1),className:"absolute -top-12 right-0 text-white hover:text-gray-300 transition-colors",children:e.jsx(se,{className:"h-8 w-8"})}),e.jsx("img",{src:_,alt:"Evidence",className:"max-w-full max-h-[90vh] object-contain rounded-lg",onClick:t=>t.stopPropagation()})]})})]}):null};export{ue as default};
