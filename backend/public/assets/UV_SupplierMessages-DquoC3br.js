import{a as I,u as R,b as V,j as e}from"./state-vendor-__gb9IU9.js";import{e as G,r as m,L as U}from"./react-vendor-QYi6USC3.js";import{u as $,a as k}from"./index-CrNOa18y.js";import{S as H,z,E as B,aF as Y,G as P,aG as J,H as W,N as X,c as Z,P as ee}from"./ui-vendor-CuJPReAW.js";const se=async(i,r,o)=>{const l=new URLSearchParams;l.append("conversation_type","customer_supplier"),i&&i!=="all"&&l.append("status",i);const u=(await k.get(`https://123create-construction-app-with-a.launchpulse.ai/api/chat/conversations?${l.toString()}`,{headers:{Authorization:`Bearer ${o}`,"Content-Type":"application/json"}})).data.map(t=>({conversation_id:t.conversation_id,customer_id:t.customer_id,customer_name:t.customer_name||"Unknown Customer",conversation_type:t.conversation_type,status:t.status,last_message_at:t.last_message_at,unread_count:t.unread_messages_count||0,related_entity_type:t.related_entity_type,related_entity_id:t.related_entity_id}));return r?u.filter(t=>t.unread_count>0):u},te=async(i,r)=>(await k.get(`https://123create-construction-app-with-a.launchpulse.ai/api/chat/conversations/${i}/messages?limit=50&offset=0`,{headers:{Authorization:`Bearer ${r}`,"Content-Type":"application/json"}})).data,ae=async(i,r,o,l)=>(await k.post(`https://123create-construction-app-with-a.launchpulse.ai/api/chat/conversations/${i}/messages`,{message_text:r,attachments:o.length>0?o:null},{headers:{Authorization:`Bearer ${l}`,"Content-Type":"application/json"}})).data,ce=()=>{const i=$(s=>s.authentication_state.auth_token),r=$(s=>s.authentication_state.supplier_profile),o=$(s=>s.websocket_connection),[l,f]=G(),u=I(),[t,K]=m.useState(null),[d,y]=m.useState({message_text:"",attachments:[],is_sending:!1}),[x,M]=m.useState({filter_type:l.get("conversation_filter")||"all",search_query:"",date_range:null}),F=m.useRef(null),b=l.get("unread_only")==="true",{data:g=[],isLoading:j,error:v,refetch:_}=R({queryKey:["supplier-conversations",x.filter_type,b],queryFn:()=>se(x.filter_type,b,i),enabled:!!i,staleTime:3e4,refetchOnWindowFocus:!0}),{data:h=[],isLoading:N,error:w}=R({queryKey:["conversation-messages",t==null?void 0:t.conversation_id],queryFn:()=>te(t.conversation_id,i),enabled:!!i&&!!t,staleTime:1e4,refetchInterval:3e4}),L=V({mutationFn:({conversationId:s,messageText:a,attachments:n})=>ae(s,a,n,i),onMutate:()=>{y(s=>({...s,is_sending:!0}))},onSuccess:s=>{u.setQueryData(["conversation-messages",t==null?void 0:t.conversation_id],(a=[])=>[...a,s]),y({message_text:"",attachments:[],is_sending:!1}),_(),C()},onError:s=>{console.error("Failed to send message:",s),y(a=>({...a,is_sending:!1})),alert("Failed to send message. Please try again.")}});m.useEffect(()=>{if(!o||!t)return;const s=o;s.emit("join_conversation",{conversation_id:t.conversation_id});const a=n=>{n.conversation_id===t.conversation_id&&(u.setQueryData(["conversation-messages",t.conversation_id],(c=[])=>c.some(p=>p.message_id===n.message_id)?c:[...c,{message_id:n.message_id,conversation_id:n.conversation_id,sender_id:n.sender_id,sender_type:n.sender_type,message_text:n.message_text,attachments:n.attachments||null,is_read:n.is_read,timestamp:n.timestamp}]),setTimeout(C,100)),_()};return s.on("chat_message_received",a),()=>{s.off("chat_message_received",a),s.emit("leave_conversation",{conversation_id:t.conversation_id})}},[o,t,u,_]);const C=()=>{var s;(s=F.current)==null||s.scrollIntoView({behavior:"smooth"})},O=m.useCallback(s=>{K(s)},[]),E=m.useCallback(s=>{s.preventDefault(),!(!t||!d.message_text.trim())&&L.mutate({conversationId:t.conversation_id,messageText:d.message_text.trim(),attachments:d.attachments})},[t,d,L]),S=s=>{M(n=>({...n,filter_type:s}));const a=new URLSearchParams(l);s!=="all"?a.set("conversation_filter",s):a.delete("conversation_filter"),f(a)},Q=()=>{const s=new URLSearchParams(l);b?s.delete("unread_only"):s.set("unread_only","true"),f(s)},A=s=>{if(!s)return"Never";const a=new Date(s),c=new Date().getTime()-a.getTime(),p=Math.floor(c/6e4),q=Math.floor(c/36e5),D=Math.floor(c/864e5);return p<1?"Just now":p<60?`${p}m ago`:q<24?`${q}h ago`:D<7?`${D}d ago`:a.toLocaleDateString()},T=(s,a)=>!s||!a?null:s==="order"?e.jsxs(U,{to:`/supplier/orders/${a}`,className:"inline-flex items-center gap-1 px-2 py-1 bg-blue-50 text-blue-700 rounded-md text-xs hover:bg-blue-100 transition-colors",children:[e.jsx(Z,{className:"w-3 h-3"}),"Order"]}):s==="product"?e.jsxs(U,{to:`/product/${a}`,className:"inline-flex items-center gap-1 px-2 py-1 bg-green-50 text-green-700 rounded-md text-xs hover:bg-green-100 transition-colors",children:[e.jsx(ee,{className:"w-3 h-3"}),"Product"]}):null;return m.useEffect(()=>{h.length>0&&C()},[h]),e.jsx(e.Fragment,{children:e.jsxs("div",{className:"min-h-screen bg-gray-50",children:[e.jsx("div",{className:"bg-white border-b border-gray-200 sticky top-16 z-10",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-gray-900",children:"Customer Messages"}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:"Manage customer inquiries and communications"})]}),g.length>0&&e.jsxs("div",{className:"flex items-center gap-6",children:[e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-gray-900",children:g.length}),e.jsx("div",{className:"text-xs text-gray-600",children:"Total Conversations"})]}),e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"text-2xl font-bold text-blue-600",children:g.filter(s=>s.unread_count>0).length}),e.jsx("div",{className:"text-xs text-gray-600",children:"Unread"})]}),(r==null?void 0:r.response_time_average)&&e.jsxs("div",{className:"text-center",children:[e.jsxs("div",{className:"text-2xl font-bold text-green-600",children:[Number(r==null?void 0:r.response_time_average).toFixed(1),"h"]}),e.jsx("div",{className:"text-xs text-gray-600",children:"Avg Response Time"})]})]})]})})}),e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6",children:e.jsxs("div",{className:"grid grid-cols-1 lg:grid-cols-3 gap-6 h-[calc(100vh-200px)]",children:[e.jsxs("div",{className:"lg:col-span-1 bg-white rounded-xl shadow-lg border border-gray-200 flex flex-col overflow-hidden",children:[e.jsxs("div",{className:"p-4 border-b border-gray-200 space-y-3",children:[e.jsxs("div",{className:"relative",children:[e.jsx(H,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 w-4 h-4 text-gray-400"}),e.jsx("input",{type:"text",placeholder:"Search conversations...",value:x.search_query,onChange:s=>M(a=>({...a,search_query:s.target.value})),className:"w-full pl-10 pr-4 py-2 border border-gray-300 rounded-lg text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[e.jsx("button",{onClick:()=>S("all"),className:`px-3 py-1 rounded-full text-xs font-medium transition-colors ${x.filter_type==="all"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"All"}),e.jsx("button",{onClick:()=>S("active"),className:`px-3 py-1 rounded-full text-xs font-medium transition-colors ${x.filter_type==="active"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Active"}),e.jsx("button",{onClick:()=>S("archived"),className:`px-3 py-1 rounded-full text-xs font-medium transition-colors ${x.filter_type==="archived"?"bg-blue-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Archived"}),e.jsx("button",{onClick:Q,className:`px-3 py-1 rounded-full text-xs font-medium transition-colors ${b?"bg-amber-600 text-white":"bg-gray-100 text-gray-700 hover:bg-gray-200"}`,children:"Unread Only"})]})]}),e.jsxs("div",{className:"flex-1 overflow-y-auto",children:[j&&e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}),v&&e.jsx("div",{className:"p-4",children:e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-sm text-red-700",children:"Failed to load conversations"})})}),!j&&!v&&g.length===0&&e.jsxs("div",{className:"flex flex-col items-center justify-center py-12 px-4",children:[e.jsx(z,{className:"w-16 h-16 text-gray-300 mb-4"}),e.jsx("p",{className:"text-gray-600 font-medium mb-2",children:"No conversations yet"}),e.jsx("p",{className:"text-sm text-gray-500 text-center",children:"Customer messages will appear here"})]}),!j&&!v&&g.length>0&&e.jsx("div",{className:"divide-y divide-gray-200",children:g.filter(s=>x.search_query===""||s.customer_name.toLowerCase().includes(x.search_query.toLowerCase())).map(s=>e.jsx("button",{onClick:()=>O(s),className:`w-full text-left p-4 hover:bg-gray-50 transition-colors ${(t==null?void 0:t.conversation_id)===s.conversation_id?"bg-blue-50 border-l-4 border-blue-600":""}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-10 h-10 rounded-full bg-blue-100 flex items-center justify-center",children:e.jsx(B,{className:"w-5 h-5 text-blue-600"})})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-1",children:[e.jsx("p",{className:`text-sm font-medium truncate ${s.unread_count>0?"text-gray-900":"text-gray-700"}`,children:s.customer_name}),s.unread_count>0&&e.jsx("span",{className:"flex-shrink-0 inline-flex items-center justify-center px-2 py-0.5 bg-blue-600 text-white rounded-full text-xs font-medium",children:s.unread_count})]}),e.jsxs("div",{className:"flex items-center gap-2 flex-wrap",children:[T(s.related_entity_type,s.related_entity_id),e.jsx("span",{className:"text-xs text-gray-500",children:A(s.last_message_at)})]}),e.jsx("div",{className:"flex items-center gap-2 mt-1",children:e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${s.status==="active"?"bg-green-50 text-green-700":"bg-gray-100 text-gray-600"}`,children:s.status})})]})]})},s.conversation_id))})]})]}),e.jsx("div",{className:"lg:col-span-2 bg-white rounded-xl shadow-lg border border-gray-200 flex flex-col overflow-hidden",children:t?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"px-6 py-4 border-b border-gray-200 bg-gray-50",children:e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"w-12 h-12 rounded-full bg-blue-100 flex items-center justify-center flex-shrink-0",children:e.jsx(B,{className:"w-6 h-6 text-blue-600"})}),e.jsxs("div",{children:[e.jsx("h3",{className:"text-lg font-semibold text-gray-900",children:t.customer_name}),e.jsxs("div",{className:"flex items-center gap-2 mt-1",children:[T(t.related_entity_type,t.related_entity_id),e.jsx("span",{className:"text-xs text-gray-500",children:"â€¢"}),e.jsx("span",{className:`inline-flex items-center px-2 py-0.5 rounded text-xs font-medium ${t.status==="active"?"bg-green-50 text-green-700":"bg-gray-100 text-gray-600"}`,children:t.status})]})]})]}),e.jsx("button",{className:"p-2 hover:bg-gray-100 rounded-lg transition-colors",children:e.jsx(Y,{className:"w-5 h-5 text-gray-600"})})]})}),e.jsxs("div",{className:"flex-1 overflow-y-auto p-6 space-y-4 bg-gray-50",children:[N&&e.jsx("div",{className:"flex items-center justify-center py-8",children:e.jsx("div",{className:"animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600"})}),w&&e.jsx("div",{className:"bg-red-50 border border-red-200 rounded-lg p-4",children:e.jsx("p",{className:"text-sm text-red-700",children:"Failed to load messages"})}),!N&&!w&&h.length===0&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-gray-600",children:"No messages yet"}),e.jsx("p",{className:"text-sm text-gray-500 mt-1",children:"Start the conversation below"})]}),!N&&!w&&h.length>0&&e.jsxs(e.Fragment,{children:[h.map(s=>{const a=s.sender_type==="supplier";return e.jsx("div",{className:`flex ${a?"justify-end":"justify-start"}`,children:e.jsxs("div",{className:`max-w-[75%] ${a?"order-2":"order-1"}`,children:[e.jsx("div",{className:`text-xs text-gray-600 mb-1 ${a?"text-right":"text-left"}`,children:a?"You":t.customer_name}),e.jsxs("div",{className:`rounded-2xl px-4 py-3 ${a?"bg-blue-600 text-white":"bg-white text-gray-900 border border-gray-200"}`,children:[e.jsx("p",{className:"text-sm whitespace-pre-wrap break-words",children:s.message_text}),s.attachments&&s.attachments.length>0&&e.jsx("div",{className:"mt-2 space-y-1",children:s.attachments.map((n,c)=>e.jsxs("a",{href:n,target:"_blank",rel:"noopener noreferrer",className:`flex items-center gap-2 text-xs underline ${a?"text-blue-100":"text-blue-600"}`,children:[e.jsx(P,{className:"w-3 h-3"}),"Attachment ",c+1]},c))})]}),e.jsxs("div",{className:`flex items-center gap-1 mt-1 text-xs text-gray-500 ${a?"justify-end":"justify-start"}`,children:[e.jsx("span",{children:A(s.timestamp)}),a&&s.is_read&&e.jsx(J,{className:"w-3 h-3 text-blue-600"})]})]})},s.message_id)}),e.jsx("div",{ref:F})]})]}),e.jsx("div",{className:"p-4 border-t border-gray-200 bg-white",children:e.jsxs("form",{onSubmit:E,className:"space-y-3",children:[e.jsx("div",{className:"relative",children:e.jsx("textarea",{value:d.message_text,onChange:s=>{y(a=>({...a,message_text:s.target.value}))},placeholder:"Type your message...",rows:3,className:"w-full px-4 py-3 border border-gray-300 rounded-lg text-sm resize-none focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent",disabled:d.is_sending,onKeyDown:s=>{(s.ctrlKey||s.metaKey)&&s.key==="Enter"&&(s.preventDefault(),E(s))}})}),e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{type:"button",className:"p-2 text-gray-600 hover:bg-gray-100 rounded-lg transition-colors",title:"Attach file (coming soon)",disabled:!0,children:e.jsx(P,{className:"w-5 h-5"})}),e.jsx("span",{className:"text-xs text-gray-500",children:"Press Ctrl+Enter to send"})]}),e.jsx("button",{type:"submit",disabled:d.is_sending||!d.message_text.trim(),className:"inline-flex items-center gap-2 px-6 py-2 bg-blue-600 text-white rounded-lg font-medium text-sm hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:ring-offset-2 disabled:opacity-50 disabled:cursor-not-allowed transition-all",children:d.is_sending?e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"animate-spin rounded-full h-4 w-4 border-b-2 border-white"}),"Sending..."]}):e.jsxs(e.Fragment,{children:[e.jsx(W,{className:"w-4 h-4"}),"Send Message"]})})]})]})})]}):e.jsxs("div",{className:"flex-1 flex flex-col items-center justify-center p-8",children:[e.jsx(z,{className:"w-20 h-20 text-gray-300 mb-4"}),e.jsx("h3",{className:"text-xl font-semibold text-gray-900 mb-2",children:"Select a conversation"}),e.jsx("p",{className:"text-gray-600 text-center max-w-md",children:"Choose a customer conversation from the list to view messages and respond"})]})})]})}),e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 pb-6",children:e.jsx("div",{className:"bg-blue-50 border border-blue-200 rounded-lg p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"flex-shrink-0",children:e.jsx("div",{className:"w-8 h-8 rounded-full bg-blue-100 flex items-center justify-center",children:e.jsx(X,{className:"w-4 h-4 text-blue-600"})})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h4",{className:"text-sm font-semibold text-blue-900 mb-1",children:"Response Time Best Practices"}),e.jsxs("p",{className:"text-sm text-blue-700",children:["Quick responses improve customer satisfaction. Aim to reply within 2 hours during business hours.",(r==null?void 0:r.response_time_average)&&e.jsxs(e.Fragment,{children:[" Your current average response time is ",e.jsxs("strong",{children:[Number(r==null?void 0:r.response_time_average).toFixed(1)," hours"]}),"."]})]})]})]})})})]})})};export{ce as default};
